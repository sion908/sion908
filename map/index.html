<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â±ÖÁïôÂú∞„Åæ„Å§„Çä ÂÜçÁîü„Åß„Åç„ÇãÂú∞Âõ≥</title>

    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

    <!-- deck.gl -->
    <script src="https://unpkg.com/deck.gl@8.9.0/dist.min.js"></script>

    <!-- Tailwind CSS for UI -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
        }

        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        /* „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆ„Çπ„Çø„Ç§„É´ */
        .deck-tooltip {
            font-family: sans-serif;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.95) !important;
            color: #333 !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            padding: 12px !important;
            max-width: 250px;
            white-space: normal !important;
        }

        /* Âêπ„ÅçÂá∫„Åó„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        #bubble-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .map-bubble {
            position: absolute;
            transform: translate(-50%, -100%);
            margin-top: -14px;
            background: white;
            border-radius: 10px;
            padding: 7px 11px;
            min-width: 100px;
            max-width: 200px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.18);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: "Noto Sans JP", "„Éí„É©„ÇÆ„ÉéËßí„Ç¥„Ç∑„ÉÉ„ÇØ", sans-serif;
        }

        .map-bubble.visible {
            opacity: 1;
        }

        /* Âêπ„ÅçÂá∫„Åó„ÅÆÂ∞ªÂ∞æÔºà‰∏ãÂêë„Åç‰∏âËßíÔºâ */
        .map-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid white;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.12));
        }

        .map-bubble .bubble-category {
            display: inline-block;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.04em;
            padding: 2px 6px;
            border-radius: 20px;
            color: white;
            margin-bottom: 4px;
        }

        .map-bubble .bubble-title {
            font-size: 12px;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.35;
            margin-bottom: 3px;
            white-space: normal;
            word-break: break-all;
        }

        .map-bubble .bubble-time {
            font-size: 10px;
            color: #64748b;
            font-weight: 500;
        }

        .map-bubble .bubble-more {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 2px;
        }

        /* „Ç∑„Éº„ÇØ„Éê„Éº„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
    </style>
</head>

<body class="bg-gray-100">

    <!-- Âú∞Âõ≥„Ç≥„É≥„ÉÜ„Éä -->
    <div id="map-container"></div>

    <!-- Âêπ„ÅçÂá∫„Åó„Ç™„Éº„Éê„Éº„É¨„Ç§„Ç≥„É≥„ÉÜ„Éä -->
    <div id="bubble-container"></div>

    <!-- UI„Éë„Éç„É´ (ÁîªÈù¢‰∏ãÈÉ®) -->
    <div
        class="absolute bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-200 p-4 pb-6 shadow-lg z-10 transition-transform duration-300">
        <div class="max-w-3xl mx-auto flex flex-col gap-4">

            <!-- „Éò„ÉÉ„ÉÄ„ÉºÔºÜÁèæÂú®ÊôÇÂàªË°®Á§∫ -->
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Â±ÖÁïôÂú∞„Åæ„Å§„Çä „Éû„ÉÉ„Éó</h1>
                    <!-- Êó•‰ªòÈÅ∏Êäû„Çø„Éñ -->
                    <div id="date-tabs" class="flex gap-1 mt-1">
                        <button data-date="2025-09-20"
                            class="date-tab px-2.5 py-1 text-xs font-bold rounded-full border transition-colors">9/20(Âúü)</button>
                        <button data-date="2025-09-21"
                            class="date-tab px-2.5 py-1 text-xs font-bold rounded-full border transition-colors">9/21(Êó•)</button>
                        <button data-date="2025-09-22"
                            class="date-tab px-2.5 py-1 text-xs font-bold rounded-full border transition-colors">9/22(Êúà)</button>
                        <button data-date="2025-09-23"
                            class="date-tab px-2.5 py-1 text-xs font-bold rounded-full border transition-colors">9/23(ÁÅ´)</button>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-xs text-gray-500 font-medium">„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÊôÇÂàª</span>
                    <div id="clock-display" class="text-3xl font-mono font-bold text-blue-600">09:00</div>
                </div>
            </div>

            <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Éê„Éº -->
            <div class="flex items-center gap-4">
                <button id="play-btn"
                    class="w-12 h-12 flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center shadow-md transition-colors">
                    <!-- ÂÜçÁîü„Ç¢„Ç§„Ç≥„É≥ -->
                    <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-6 h-6">
                        <path fill-rule="evenodd"
                            d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z"
                            clip-rule="evenodd" />
                    </svg>
                    <!-- ‰∏ÄÊôÇÂÅúÊ≠¢„Ç¢„Ç§„Ç≥„É≥ (ÂàùÊúüÈùûË°®Á§∫) -->
                    <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-6 h-6 hidden">
                        <path fill-rule="evenodd"
                            d="M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0115 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H15a.75.75 0 01-.75-.75V5.25z"
                            clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- 10ÂÄçÈÄü„Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥ -->
                <button id="speed-btn"
                    class="flex-shrink-0 px-3 h-9 bg-gray-100 hover:bg-amber-100 border border-gray-300 hover:border-amber-400 text-gray-600 hover:text-amber-700 text-xs font-bold rounded-lg transition-colors"
                    title="„Éá„Éê„ÉÉ„Ç∞Áî®: ÂÜçÁîüÈÄüÂ∫¶„Çí10ÂÄç„Å´„Åô„Çã">
                    √ó10ÈÄü
                </button>

                <div class="flex-grow flex flex-col gap-1">
                    <input type="range" id="time-slider" min="0" max="100" value="0">
                    <div class="flex justify-between text-xs text-gray-500 font-medium px-1">
                        <span>09:00</span>
                        <span>13:00</span>
                        <span>18:00</span>
                        <span>21:00</span>
                    </div>
                </div>
            </div>

            <!-- Âá°‰æã -->
            <div class="flex gap-3 text-xs font-medium justify-center mt-2 flex-wrap">
                <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full"
                        style="background:#f97316"></span> È£≤È£ü</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full"
                        style="background:#3b82f6"></span> „Çπ„ÉÜ„Éº„Ç∏„ÉªÈü≥Ê•Ω</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full"
                        style="background:#10b981"></span> ‰ΩìÈ®ì„ÉªWS</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full"
                        style="background:#8b5cf6"></span> Â§ú„Éª‰∫§ÊµÅ</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-500"></span> „Åù„ÅÆ‰ªñ</div>
                <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></span>
                    „Éë„É¨„Éº„Éâ(ÁßªÂãï)</div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ---
        let eventsData = [];
        let locationsData = [];
        let routesData = [];
        let processedEvents = [];
        let processedRoutes = [];

        // --- 2. „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÊôÇÈñì Ë®≠ÂÆö ---
        let targetDateStr = "2025-09-20"; // ÈÅ∏Êäû‰∏≠„ÅÆÊó•‰ªòÔºàÂàáÊõøÂèØËÉΩÔºâ
        const SIM_START_SEC = 9 * 3600;   // 09:00
        const SIM_END_SEC = 21 * 3600;  // 21:00
        const SIM_DURATION = SIM_END_SEC - SIM_START_SEC;

        let currentSimSec = 0;
        let isPlaying = false;
        let lastFrameTime = 0;
        const PLAYBACK_SPEED_NORMAL = 120; // ÈÄöÂ∏∏ÈÄüÂ∫¶: 1Áßí„Åß2ÂàÜÈÄ≤„ÇÄ
        const PLAYBACK_SPEED_FAST = 1200; // „Éá„Éê„ÉÉ„Ç∞ÈÄüÂ∫¶: 1Áßí„Åß20ÂàÜÈÄ≤„ÇÄ
        let playbackSpeed = PLAYBACK_SPEED_NORMAL;

        // --- 3. „Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å®Âá¶ÁêÜ ---
        let allEventsData = []; // ÂÖ®Êó•Á®ã„ÅÆÂÖ®„Ç§„Éô„É≥„Éà„Çí‰øùÊåÅ

        async function loadData() {
            try {
                const [evtRes, locRes, routeRes] = await Promise.all([
                    fetch('event.json'),
                    fetch('location.json'),
                    fetch('route.json')
                ]);

                const rawEvents = await evtRes.json();
                const rawLocations = await locRes.json();
                const rawRoutes = await routeRes.json();

                // Â†¥ÊâÄMap‰ΩúÊàê
                const locMap = new Map(rawLocations.map(l => [l.id, l]));

                // ÂÖ®„Ç§„Éô„É≥„Éà„Éá„Éº„ÇøÂä†Â∑•ÔºàÊó•‰ªò„Éï„Ç£„É´„Çø„Å™„ÅóÔºâ
                allEventsData = rawEvents.map(evt => {
                    const loc = locMap.get(evt.location_id);
                    return {
                        ...evt,
                        coordinates: loc ? loc.coordinates : [129.870, 32.735],
                        location_name: loc ? loc.name : "‰∏çÊòé„Å™Â†¥ÊâÄ"
                    };
                });

                // „É´„Éº„Éà„Éá„Éº„ÇøÔºàÊó¢Â≠ò„Åù„ÅÆ„Åæ„ÅæÔºâ
                processedRoutes = rawRoutes.map(route => {
                    const startD = new Date(route.start_time);
                    const routeStartSec = startD.getHours() * 3600 + startD.getMinutes() * 60;
                    const simRouteStart = routeStartSec - SIM_START_SEC;
                    const absoluteTimestamps = route.timestamps.map(t => simRouteStart + t);
                    return {
                        ...route,
                        simStart: simRouteStart,
                        simEnd: absoluteTimestamps[absoluteTimestamps.length - 1],
                        timestamps: absoluteTimestamps
                    };
                });

                // ÂàùÊúüÊó•‰ªò„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                filterEventsByDate(targetDateStr);

            } catch (e) {
                console.error("Data load failed:", e);
                alert("„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            }
        }

        // Êó•‰ªò„Åß„Ç§„Éô„É≥„Éà„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterEventsByDate(dateStr) {
            const targetEvents = allEventsData.filter(evt => evt.start_time.startsWith(dateStr));
            processedEvents = targetEvents.map(evt => {
                const startD = new Date(evt.start_time);
                const endD = new Date(evt.end_time);
                const startSec = startD.getHours() * 3600 + startD.getMinutes() * 60;
                const endSec = endD.getHours() * 3600 + endD.getMinutes() * 60;
                return {
                    ...evt,
                    simStart: startSec - SIM_START_SEC,
                    simEnd: endSec - SIM_START_SEC
                };
            });
            console.log("Filtered:", processedEvents.length, "events for", dateStr);
            updateUI();
        }

        // --- 4. Âú∞Âõ≥„Å®Deck.gl„ÅÆÂàùÊúüÂåñ ---
        const map = new maplibregl.Map({
            container: 'map-container',
            style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
            center: [129.872, 32.736],
            zoom: 15,
            pitch: 45,
            bearing: -20
        });

        const deckOverlay = new deck.MapboxOverlay({
            layers: [],
            getTooltip: ({ object }) => {
                if (!object) return null;
                if (object.location_name) {
                    return {
                        html: `
                            <div class="font-bold text-base mb-1">${object.title}</div>
                            <div class="text-xs text-gray-500 mb-2">üìç ${object.location_name}</div>
                            <div class="text-sm">${object.description || ''}</div>
                            <div class="text-xs text-gray-400 mt-1">${object.start_time.slice(11, 16)} - ${object.end_time.slice(11, 16)}</div>
                        `
                    };
                } else if (object.path) {
                    return {
                        html: `<div class="font-bold text-base text-red-600 mb-1">üé∫ ${object.title}</div>`
                    };
                }
            }
        });

        map.addControl(deckOverlay);

        // --- 5. ÊèèÁîªÊõ¥Êñ∞„É≠„Ç∏„ÉÉ„ÇØ ---

        // „Ç´„ÉÜ„Ç¥„É™ÂÆöÁæ©ÔºàËâ≤„Éª„É©„Éô„É´„Çí‰∏ÄÂÖÉÁÆ°ÁêÜÔºâ
        const CATEGORY_COLORS = {
            'food': [249, 115, 22, 220],
            'stage': [59, 130, 246, 220],
            'experience': [16, 185, 129, 220],
            'night': [139, 92, 246, 220],
            'default': [107, 114, 128, 220],
        };
        const CATEGORY_LABELS = {
            'food': 'È£≤È£ü',
            'stage': '„Çπ„ÉÜ„Éº„Ç∏„ÉªÈü≥Ê•Ω',
            'experience': '‰ΩìÈ®ì„ÉªWS',
            'night': 'Â§ú„Éª‰∫§ÊµÅ',
            'default': '„Åù„ÅÆ‰ªñ',
        };
        const getCategoryColor = (cat) => CATEGORY_COLORS[cat] || CATEGORY_COLORS['default'];
        const toRgbStr = (c) => `rgb(${c[0]},${c[1]},${c[2]})`;

        // ---- Âêπ„ÅçÂá∫„Åó DOM ÁÆ°ÁêÜ ----
        const bubbleContainer = document.getElementById('bubble-container');
        const activeBubbles = new Map(); // location_id -> DOM element

        function updateBubbles(groupedEvents) {
            const currentIds = new Set(groupedEvents.map(g => g.location_id));

            // ‰∏çË¶Å„Å´„Å™„Å£„ÅüÂêπ„ÅçÂá∫„Åó„ÇíÂâäÈô§
            for (const [id, el] of activeBubbles) {
                if (!currentIds.has(id)) {
                    el.classList.remove('visible');
                    setTimeout(() => { if (el.parentNode) el.remove(); }, 310);
                    activeBubbles.delete(id);
                }
            }

            // Êñ∞Ë¶è or Êõ¥Êñ∞
            for (const g of groupedEvents) {
                const color = getCategoryColor(g.category);
                const catLabel = CATEGORY_LABELS[g.category] || CATEGORY_LABELS['default'];
                const colorStr = toRgbStr(color);

                let el = activeBubbles.get(g.location_id);
                if (!el) {
                    el = document.createElement('div');
                    el.className = 'map-bubble';
                    bubbleContainer.appendChild(el);
                    activeBubbles.set(g.location_id, el);
                    // „Éï„Çß„Éº„Éâ„Ç§„É≥
                    requestAnimationFrame(() => el.classList.add('visible'));
                }

                // „Ç≥„É≥„ÉÜ„É≥„ÉÑÊõ¥Êñ∞
                const moreHtml = g.titles.length > 1
                    ? `<div class="bubble-more">„Åª„Åã ${g.titles.length - 1} ‰ª∂</div>`
                    : '';
                el.innerHTML = `
                    <div class="bubble-category" style="background:${colorStr}">${catLabel}</div>
                    <div class="bubble-title">${g.title}</div>
                    <div class="bubble-time">${g.start_time.slice(11, 16)} - ${g.end_time.slice(11, 16)}</div>
                    ${moreHtml}
                `;
                el.dataset.lng = g.coordinates[0];
                el.dataset.lat = g.coordinates[1];
            }
        }

        function repositionBubbles() {
            for (const [id, el] of activeBubbles) {
                const lng = parseFloat(el.dataset.lng);
                const lat = parseFloat(el.dataset.lat);
                if (isNaN(lng) || isNaN(lat)) continue;
                const pt = map.project([lng, lat]);
                el.style.left = `${pt.x}px`;
                el.style.top = `${pt.y - 18}px`; // „Éî„É≥„ÅÆ‰∏ä„Å´Â∞ë„Åó‰ΩôË£ï
            }
        }

        function updateLayers() {
            const activeEvents = processedEvents.filter(e => currentSimSec >= e.simStart && currentSimSec <= e.simEnd);

            // Âêå„ÅòÂ∫ßÊ®ô„Å´Ë§áÊï∞„Ç§„Éô„É≥„Éà„ÅåÈáç„Å™„ÇãÂ†¥Âêà„ÇíËÄÉÊÖÆ„Åó„Å¶Â†¥ÊâÄ„Åî„Å®„Å´ÈõÜÁ¥Ñ
            const locationGroups = {};
            for (const e of activeEvents) {
                const key = e.location_id;
                if (!locationGroups[key]) {
                    locationGroups[key] = { ...e, titles: [e.title] };
                } else {
                    locationGroups[key].titles.push(e.title);
                }
            }
            const groupedForLabels = Object.values(locationGroups);

            // Âêπ„ÅçÂá∫„ÅóÊõ¥Êñ∞
            updateBubbles(groupedForLabels);
            repositionBubbles();

            const layers = [
                // ‚óØ „Ç§„Éô„É≥„Éà„Éî„É≥
                new deck.ScatterplotLayer({
                    id: 'events-layer',
                    data: activeEvents,
                    getPosition: d => d.coordinates,
                    getFillColor: d => getCategoryColor(d.category),
                    getLineColor: [255, 255, 255],
                    lineWidthMinPixels: 2,
                    getRadius: 10,
                    radiusUnits: 'meters',
                    radiusMinPixels: 8,
                    radiusMaxPixels: 24,
                    pickable: true,
                    opacity: 0.9
                }),

                // „Éë„É¨„Éº„ÉâÔºàTripsLayerÔºâ
                new deck.TripsLayer({
                    id: 'trips-layer',
                    data: processedRoutes,
                    getPath: d => d.path,
                    getTimestamps: d => d.timestamps,
                    getColor: [239, 68, 68],
                    opacity: 0.9,
                    widthMinPixels: 8,
                    rounded: true,
                    trailLength: 600,
                    currentTime: currentSimSec,
                    pickable: true
                })
            ];

            deckOverlay.setProps({ layers });
        }

        // --- 6. UIÂà∂Âæ° ---
        const slider = document.getElementById('time-slider');
        const clockDisplay = document.getElementById('clock-display');
        const playBtn = document.getElementById('play-btn');
        const iconPlay = document.getElementById('icon-play');
        const iconPause = document.getElementById('icon-pause');

        slider.max = SIM_DURATION;

        function formatTime(totalSeconds) {
            const absoluteSec = SIM_START_SEC + totalSeconds;
            let h = Math.floor(absoluteSec / 3600);
            let m = Math.floor((absoluteSec % 3600) / 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        function updateUI() {
            slider.value = currentSimSec;
            clockDisplay.innerText = formatTime(currentSimSec);
            updateLayers();
        }

        function animate(time) {
            if (!lastFrameTime) lastFrameTime = time;
            const deltaTime = (time - lastFrameTime) / 1000;
            lastFrameTime = time;

            if (isPlaying) {
                currentSimSec += deltaTime * playbackSpeed;
                if (currentSimSec > SIM_DURATION) {
                    currentSimSec = 0;
                    isPlaying = false;
                    togglePlayState();
                }
                updateUI();
            } else {
                // ÂÜçÁîü‰∏≠„Åß„Å™„Åè„Å¶„ÇÇÂú∞Âõ≥„Éë„É≥„Éª„Ç∫„Éº„É†ÊôÇ„Å´Âêπ„ÅçÂá∫„Åó‰ΩçÁΩÆ„ÇíËøΩÂæì„Åï„Åõ„Çã
                repositionBubbles();
            }
            requestAnimationFrame(animate);
        }

        function togglePlayState() {
            if (isPlaying) {
                iconPlay.classList.add('hidden');
                iconPause.classList.remove('hidden');
            } else {
                iconPlay.classList.remove('hidden');
                iconPause.classList.add('hidden');
            }
        }

        playBtn.addEventListener('click', () => {
            isPlaying = !isPlaying;
            togglePlayState();
        });

        const speedBtn = document.getElementById('speed-btn');
        speedBtn.addEventListener('click', () => {
            const isFast = playbackSpeed === PLAYBACK_SPEED_FAST;
            playbackSpeed = isFast ? PLAYBACK_SPEED_NORMAL : PLAYBACK_SPEED_FAST;
            // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆ„ÇíÂàá„ÇäÊõø„Åà
            if (isFast) {
                speedBtn.textContent = '√ó10ÈÄü';
                speedBtn.classList.remove('bg-amber-400', 'text-amber-900', 'border-amber-500');
                speedBtn.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-300');
            } else {
                speedBtn.textContent = '√ó1ÈÄüÔºàÊ®ôÊ∫ñÔºâ';
                speedBtn.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-300');
                speedBtn.classList.add('bg-amber-400', 'text-amber-900', 'border-amber-500');
            }
        });

        slider.addEventListener('input', (e) => {
            currentSimSec = parseFloat(e.target.value);
            updateUI();
        });

        // --- Êó•‰ªò„Çø„Éñ ---
        function setActiveTab(dateStr) {
            document.querySelectorAll('.date-tab').forEach(btn => {
                const isActive = btn.dataset.date === dateStr;
                btn.classList.toggle('bg-blue-600', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('border-blue-600', isActive);
                btn.classList.toggle('bg-white', !isActive);
                btn.classList.toggle('text-gray-600', !isActive);
                btn.classList.toggle('border-gray-300', !isActive);
            });
        }

        document.querySelectorAll('.date-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                const dateStr = btn.dataset.date;
                if (dateStr === targetDateStr) return;
                targetDateStr = dateStr;
                // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Çí„É™„Çª„ÉÉ„Éà
                currentSimSec = 0;
                isPlaying = false;
                togglePlayState();
                // Âêπ„ÅçÂá∫„Åó„ÇíÂÖ®„ÇØ„É™„Ç¢
                for (const [, el] of activeBubbles) el.remove();
                activeBubbles.clear();
                // „Ç§„Éô„É≥„Éà„ÇíÂàáÊõø
                setActiveTab(dateStr);
                filterEventsByDate(dateStr);
            });
        });

        // --- 7. ÈñãÂßã ---
        map.on('load', () => {
            loadData();
            requestAnimationFrame(animate);
            setActiveTab(targetDateStr); // ÂàùÊúü„Çø„Éñ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
        });
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
    </script>
</body>

</html>